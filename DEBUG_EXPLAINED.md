# ðŸ” è°ƒè¯•åŽŸç†è¯¦è§£

## é—®é¢˜ 1ï¼šSSH Tunnel è¿œç¨‹è°ƒè¯•åŽŸç†

### ðŸŒ SSH ç«¯å£è½¬å‘å·¥ä½œåŽŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         SSH Tunnel          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°ç”µè„‘      â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’          â”‚   è¿œç¨‹æœåŠ¡å™¨    â”‚
â”‚  (Cursor IDE)   â”‚                              â”‚  (Python åº”ç”¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                               â”‚
         â”‚  localhost:5678                               â”‚  localhost:5678
         â”‚  (è°ƒè¯•å™¨è¿žæŽ¥è¿™é‡Œ)                             â”‚  (debugpy ç›‘å¬è¿™é‡Œ)
         â”‚                                               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  SSH ç«¯å£è½¬å‘ (5678:5678)
```

### ðŸ“Š æ•°æ®æµå‘

```
1. Cursor è°ƒè¯•å™¨
   â†“ (è¿žæŽ¥åˆ° localhost:5678)
   
2. SSH å®¢æˆ·ç«¯ï¼ˆæœ¬åœ°ï¼‰
   â†“ (é€šè¿‡ SSH éš§é“è½¬å‘)
   
3. SSH æœåŠ¡å™¨ï¼ˆè¿œç¨‹ï¼‰
   â†“ (è½¬å‘åˆ° localhost:5678)
   
4. debugpyï¼ˆè¿œç¨‹æœåŠ¡å™¨ä¸Šï¼‰
   â†“ (æŽ¥æ”¶è°ƒè¯•å‘½ä»¤)
   
5. Python è¿›ç¨‹ï¼ˆè¿œç¨‹æœåŠ¡å™¨ä¸Šï¼‰
```

### ðŸ”§ æŠ€æœ¯ç»†èŠ‚

**SSH å‘½ä»¤ï¼š**
```bash
ssh -L 5678:localhost:5678 user@remote
```

**å‚æ•°è§£é‡Šï¼š**
- `-L` = Local port forwardingï¼ˆæœ¬åœ°ç«¯å£è½¬å‘ï¼‰
- `5678:localhost:5678` = æœ¬åœ°ç«¯å£:è¿œç¨‹ä¸»æœº:è¿œç¨‹ç«¯å£
- æ„æ€ï¼šæœ¬åœ° 5678 â†’ SSH éš§é“ â†’ è¿œç¨‹ localhost:5678

**ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ**
- âœ… ä¸éœ€è¦åœ¨é˜²ç«å¢™å¼€æ”¾ç«¯å£ 5678
- âœ… æ•°æ®é€šè¿‡åŠ å¯†çš„ SSH è¿žæŽ¥ä¼ è¾“
- âœ… å¤–éƒ¨æ— æ³•ç›´æŽ¥è®¿é—®è°ƒè¯•ç«¯å£

---

## é—®é¢˜ 2ï¼šä¸ºä»€ä¹ˆ `get_answer` æ–­ç‚¹æ•èŽ·ä¸åˆ°ï¼Ÿ

### ðŸŽ¯ æ ¸å¿ƒåŽŸå› ï¼š**æ‰§è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼**

### ðŸ“‹ ä»£ç æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›ç¨‹ 1ï¼šFastAPI (uvicorn)                              â”‚
â”‚  ä½ å½“å‰è°ƒè¯•å™¨è¿žæŽ¥çš„è¿›ç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç”¨æˆ·è¯·æ±‚ â†’ /qa/ask                                  â”‚
â”‚  2. app/routers/qa.py:ask_question()                   â”‚
â”‚  3. answer_question_task.delay()  â† åªæ˜¯æäº¤ä»»åŠ¡ï¼      â”‚
â”‚      â†“                                                    â”‚
â”‚      [ä»»åŠ¡å‘é€åˆ° Redisï¼Œå‡½æ•°ç«‹å³è¿”å›ž task_id]            â”‚
â”‚                                                          â”‚
â”‚  âŒ get_answer() ä¸ä¼šåœ¨è¿™é‡Œæ‰§è¡Œï¼                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                    [Redis æ¶ˆæ¯é˜Ÿåˆ—]
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›ç¨‹ 2ï¼šCelery Workerï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰                       â”‚
â”‚  âš ï¸ ä½ éœ€è¦åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­è°ƒè¯•ï¼                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Worker ä»Ž Redis æŽ¥æ”¶ä»»åŠ¡                            â”‚
â”‚  2. worker/tasks.py:answer_question_task()              â”‚
â”‚  3. è°ƒç”¨ process_question()                             â”‚
â”‚  4. è°ƒç”¨ get_answer()  â† æ–­ç‚¹åº”è¯¥è®¾ç½®åœ¨è¿™é‡Œ              â”‚
â”‚                                                          â”‚
â”‚  âœ… get_answer() åœ¨è¿™é‡Œæ‰§è¡Œï¼                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ðŸ” è¯¦ç»†åˆ†æž

#### 1. FastAPI è¿›ç¨‹ï¼ˆä½ å½“å‰è°ƒè¯•çš„ï¼‰

```python
# app/routers/qa.py
@router.post("/ask")
async def ask_question(...):
    # è¿™è¡Œä»£ç åœ¨ä½ çš„è°ƒè¯•å™¨è¿žæŽ¥çš„è¿›ç¨‹ä¸­æ‰§è¡Œ
    task = answer_question_task.delay(question_data.question, user)
    # â†‘ è¿™åªæ˜¯å‘é€ä»»åŠ¡åˆ° Redisï¼Œä¸ä¼šæ‰§è¡Œä»»åŠ¡æœ¬èº«ï¼
    return {"task_id": task.id}
```

**`.delay()` åšäº†ä»€ä¹ˆï¼Ÿ**
- åºåˆ—åŒ–å‡½æ•°å’Œå‚æ•°
- å‘é€åˆ° Redisï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- ç«‹å³è¿”å›žï¼ˆä¸ç­‰å¾…ä»»åŠ¡å®Œæˆï¼‰
- âŒ **ä¸åœ¨å½“å‰è¿›ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡**

#### 2. Celery Worker è¿›ç¨‹ï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰

```python
# worker/tasks.py
@celery_app.task
def answer_question_task(question: str, user_id: str):
    # â† è¿™è¡Œä»£ç åœ¨ Worker è¿›ç¨‹ä¸­æ‰§è¡Œ
    return process_question(question, user_id)
    #    â†“
    # app/services/llm_services.py
    def process_question(...):
        answer = get_answer(question, context)
        # â† get_answer() åœ¨ Worker è¿›ç¨‹ä¸­æ‰§è¡Œï¼
```

**Worker è¿›ç¨‹ï¼š**
- æ˜¯ç‹¬ç«‹çš„ Python è¿›ç¨‹
- ä»Ž Redis æŽ¥æ”¶ä»»åŠ¡
- æ‰§è¡Œä»»åŠ¡å‡½æ•°
- âœ… **`get_answer()` åœ¨è¿™é‡Œæ‰§è¡Œ**

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šè°ƒè¯• Celery Worker

### æ–¹æ³• 1ï¼šå•ç‹¬è°ƒè¯• Worker è¿›ç¨‹ï¼ˆæŽ¨èï¼‰

#### æ­¥éª¤ 1ï¼šåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå¯åŠ¨ Workerï¼ˆå¸¦è°ƒè¯•ï¼‰

```bash
# SSH åˆ°è¿œç¨‹æœåŠ¡å™¨
ssh root@192.168.189.246 -p 20022
cd /root/MyAgent

# å¯åŠ¨ Workerï¼ˆå¸¦è°ƒè¯•ï¼‰
export ENABLE_REMOTE_DEBUG=1
export DEBUG_PORT=5679  # ä½¿ç”¨ä¸åŒç«¯å£ï¼Œé¿å…å’Œ FastAPI å†²çª

# åˆ›å»º worker_debug.py
cat > worker_debug.py << 'EOF'
import os
import sys

# å¯ç”¨è°ƒè¯•
if os.getenv("ENABLE_REMOTE_DEBUG") == "1":
    import debugpy
    port = int(os.getenv("DEBUG_PORT", "5679"))
    debugpy.listen(('0.0.0.0', port))
    print(f"ðŸ”§ Worker è°ƒè¯•å·²å¯ç”¨ï¼Œç«¯å£ {port}")

# å¯åŠ¨ Celery Worker
from celery import Celery
from worker.celery_app import celery_app

if __name__ == '__main__':
    celery_app.worker_main([
        'worker',
        '--loglevel=info',
        '--pool=solo',  # å•è¿›ç¨‹æ¨¡å¼ï¼Œå¿…é¡»ç”¨äºŽè°ƒè¯•
        '-Q', 'qa_queue'
    ])
EOF

python worker_debug.py
```

#### æ­¥éª¤ 2ï¼šåœ¨æœ¬åœ°å»ºç«‹ç¬¬äºŒä¸ª SSH éš§é“

```bash
# å»ºç«‹ Worker è°ƒè¯•ç«¯å£è½¬å‘ï¼ˆæ–°ç»ˆç«¯ï¼‰
ssh -f -N -L 5679:localhost:5679 root@192.168.189.246 -p 20022

# éªŒè¯
nc -zv localhost 5679
```

#### æ­¥éª¤ 3ï¼šåœ¨ Cursor ä¸­æ·»åŠ  Worker è°ƒè¯•é…ç½®

æ›´æ–° `.vscode/launch.json`ï¼Œæ·»åŠ  Worker è°ƒè¯•é…ç½®ï¼š

```json
{
    "name": "Python: Celery Worker Remote",
    "type": "debugpy",
    "request": "attach",
    "connect": {
        "host": "localhost",
        "port": 5679  // Worker è°ƒè¯•ç«¯å£
    },
    "pathMappings": [
        {
            "localRoot": "${workspaceFolder}",
            "remoteRoot": "/root/MyAgent"
        }
    ],
    "justMyCode": false
}
```

#### æ­¥éª¤ 4ï¼šåœ¨ Worker è¿›ç¨‹ä¸­è®¾ç½®æ–­ç‚¹

1. åœ¨ `app/services/llm_services.py` çš„ `get_answer()` å‡½æ•°ä¸­è®¾ç½®æ–­ç‚¹
2. æŒ‰ `F5`ï¼Œé€‰æ‹© "Python: Celery Worker Remote"
3. å‘é€è¯·æ±‚åˆ° `/qa/ask`
4. æ–­ç‚¹ä¼šåœ¨ Worker è¿›ç¨‹ä¸­è§¦å‘ï¼

---

### æ–¹æ³• 2ï¼šåœ¨ Worker å¯åŠ¨è„šæœ¬ä¸­å¯ç”¨è°ƒè¯•

æ›´æ–° `worker/tasks.py` æˆ–åœ¨ Worker å¯åŠ¨æ—¶æ³¨å…¥è°ƒè¯•ä»£ç ã€‚

---

## ðŸ“Š è¿›ç¨‹å¯¹æ¯”

| è¿›ç¨‹ | è°ƒè¯•ç«¯å£ | æ‰§è¡Œå†…å®¹ | æ–­ç‚¹ä½ç½® |
|------|---------|---------|---------|
| **FastAPI** | 5678 | `ask_question()` | `app/routers/qa.py` |
| **Celery Worker** | 5679 | `get_answer()` | `app/services/llm_services.py` |

---

## ðŸŽ¯ æ­£ç¡®çš„è°ƒè¯•æµç¨‹

### è°ƒè¯• FastAPIï¼ˆå½“å‰å·²é…ç½®ï¼‰

1. è¿žæŽ¥è°ƒè¯•å™¨åˆ° FastAPI è¿›ç¨‹ï¼ˆç«¯å£ 5678ï¼‰
2. åœ¨ `app/routers/qa.py:ask_question()` è®¾ç½®æ–­ç‚¹
3. âœ… å¯ä»¥æ•èŽ·è¯·æ±‚å¤„ç†ã€å‚æ•°éªŒè¯ç­‰

### è°ƒè¯• Celery Workerï¼ˆéœ€è¦é¢å¤–é…ç½®ï¼‰

1. è¿žæŽ¥è°ƒè¯•å™¨åˆ° Worker è¿›ç¨‹ï¼ˆç«¯å£ 5679ï¼‰
2. åœ¨ `app/services/llm_services.py:get_answer()` è®¾ç½®æ–­ç‚¹
3. âœ… å¯ä»¥æ•èŽ·æ¨¡åž‹æŽ¨ç†ã€æ•°æ®å¤„ç†ç­‰

### åŒæ—¶è°ƒè¯•ä¸¤ä¸ªè¿›ç¨‹

ä½ å¯ä»¥åŒæ—¶è¿è¡Œä¸¤ä¸ªè°ƒè¯•ä¼šè¯ï¼š
- è°ƒè¯•å™¨ 1ï¼šè¿žæŽ¥åˆ° FastAPIï¼ˆç«¯å£ 5678ï¼‰
- è°ƒè¯•å™¨ 2ï¼šè¿žæŽ¥åˆ° Workerï¼ˆç«¯å£ 5679ï¼‰

**æ³¨æ„**ï¼šCursor/VSCode ä¸€æ¬¡åªèƒ½è¿žæŽ¥ä¸€ä¸ªè°ƒè¯•ä¼šè¯ï¼Œä½†ä½ å¯ä»¥ï¼š
1. å…ˆè°ƒè¯• FastAPIï¼Œäº†è§£è¯·æ±‚æµç¨‹
2. æ–­å¼€è¿žæŽ¥
3. è¿žæŽ¥åˆ° Workerï¼Œè°ƒè¯•å®žé™…æ‰§è¡Œé€»è¾‘

---

## ðŸ”§ å¿«é€Ÿä¿®å¤ï¼šåˆ›å»º Worker è°ƒè¯•è„šæœ¬

æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **Worker è°ƒè¯•å¯åŠ¨è„šæœ¬**
2. **æ›´æ–° launch.json é…ç½®**
3. **è¯¦ç»†çš„è°ƒè¯•æŒ‡å—**

è®©æˆ‘ä»¬çŽ°åœ¨å®žçŽ°å®ƒï¼

